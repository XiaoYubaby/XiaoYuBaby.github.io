<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android,gps," />





  <link rel="alternate" href="/atom.xml" title="XiaoYubaby's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Android GPS 框架
下图是基于高通平台GPS实现的基本框架图，因为高通SOC多核机制，GPS事务处理的核心是在Modem侧的核上，下文我们只分析在AP核上的实现部分，意在分析Android部分的实现。

应用层通过LM调用android location
在Android中，定位服务提供给应用层的 API 位于 android.location 包中，它其中包含的类和接口如下所示：

对">
<meta property="og:type" content="article">
<meta property="og:title" content="基于高通平台Android-GPS架构分析">
<meta property="og:url" content="xiaoyubaby.github.io/2017/03/02/基于高通平台Android-GPS架构分析/index.html">
<meta property="og:site_name" content="XiaoYubaby's Blog">
<meta property="og:description" content="Android GPS 框架
下图是基于高通平台GPS实现的基本框架图，因为高通SOC多核机制，GPS事务处理的核心是在Modem侧的核上，下文我们只分析在AP核上的实现部分，意在分析Android部分的实现。

应用层通过LM调用android location
在Android中，定位服务提供给应用层的 API 位于 android.location 包中，它其中包含的类和接口如下所示：

对">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/f92wns8h1ptldeabtmykyqxu/Gps.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/rwjtqc3ztzouii6hzge59a2o/android_location.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/q0nqvduldvk847g82k2g3dqw/android_location.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/pm6ttuqw77eu3ohi6vcccu96/LocationProviderInterfaces.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/cveczwhroarioo5ip4ryuxuj/LocationProviderInterfaces.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/87c93ypt4ho56vxkscjuj3nw/GpsLP_Interfaces.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/rktpv9cndc3t1q1jg9wdfr4b/GpsLp_handleInterfaces.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/ill34vgesjtvnblzi9s2444l/GpsLP_native_methods.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/81h614p9zhw71roi7rawlsx4/GpsLP_jni_callback_methods.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/t9dgna2xtifg5h1i7m3t3r91/GpsLP_JNI.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/pgrz91p83fyt7mkiec7iso0p/GPS%20%E5%90%AF%E5%8A%A8.png">
<meta property="og:image" content="http://static.zybuluo.com/EasonZxp/xmnp8gvzv8wwn3bn6djn3e3i/Gps_Location_report.png">
<meta property="og:updated_time" content="2017-03-02T03:24:52.688Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于高通平台Android-GPS架构分析">
<meta name="twitter:description" content="Android GPS 框架
下图是基于高通平台GPS实现的基本框架图，因为高通SOC多核机制，GPS事务处理的核心是在Modem侧的核上，下文我们只分析在AP核上的实现部分，意在分析Android部分的实现。

应用层通过LM调用android location
在Android中，定位服务提供给应用层的 API 位于 android.location 包中，它其中包含的类和接口如下所示：

对">
<meta name="twitter:image" content="http://static.zybuluo.com/EasonZxp/f92wns8h1ptldeabtmykyqxu/Gps.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="xiaoyubaby.github.io/2017/03/02/基于高通平台Android-GPS架构分析/"/>





  <title> 基于高通平台Android-GPS架构分析 | XiaoYubaby's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">XiaoYubaby's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">心有猛虎 细嗅蔷薇</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="xiaoyubaby.github.io/2017/03/02/基于高通平台Android-GPS架构分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Eason Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="XiaoYubaby's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                基于高通平台Android-GPS架构分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-02T10:47:20+08:00">
                2017-03-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android技术总结/" itemprop="url" rel="index">
                    <span itemprop="name">Android技术总结</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/02/基于高通平台Android-GPS架构分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/02/基于高通平台Android-GPS架构分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Android-GPS-框架"><a href="#Android-GPS-框架" class="headerlink" title="Android GPS 框架"></a>Android GPS 框架</h2><hr>
<p>下图是基于高通平台GPS实现的基本框架图，因为高通SOC多核机制，GPS事务处理的核心是在Modem侧的核上，下文我们只分析在AP核上的实现部分，意在分析Android部分的实现。</p>
<p><img src="http://static.zybuluo.com/EasonZxp/f92wns8h1ptldeabtmykyqxu/Gps.png" alt="Gps.png-35.3kB"></p>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><h3 id="通过LM调用android-location"><a href="#通过LM调用android-location" class="headerlink" title="通过LM调用android location"></a>通过LM调用android location</h3><hr>
<p>在Android中，定位服务提供给应用层的 API 位于 android.location 包中，它其中包含的类和接口如下所示：</p>
<p><img src="http://static.zybuluo.com/EasonZxp/rwjtqc3ztzouii6hzge59a2o/android_location.png" alt="android_location.png-68.2kB"></p>
<p>对应中文描述如下：<br><img src="http://static.zybuluo.com/EasonZxp/q0nqvduldvk847g82k2g3dqw/android_location.png" alt="android_location.png-29kB"></p>
<p>下面是摘自网上的一个获取定位信息的简单例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123; </div><div class="line">	</div><div class="line"> <span class="comment">// 测试使用的日志 Tag </span></div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"LocationService API Demo"</span>; </div><div class="line"> <span class="comment">// 将在 onCreate 中被初始化</span></div><div class="line"> <span class="keyword">private</span> LocationManager locationManager; </div><div class="line"> <span class="comment">// 接受位置更新的监听器</span></div><div class="line"> <span class="keyword">protected</span> <span class="keyword">final</span> LocationListener locationListener = </div><div class="line">                                 <span class="keyword">new</span> 			 LocationListener() &#123; </div><div class="line">	</div><div class="line">   <span class="comment">// 当位置发生变化时，输出位置信息</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLocationChanged</span><span class="params">(Location location)</span> </span>&#123; </div><div class="line">     Log.d(TAG, <span class="string">"Location changed to: "</span> + getLocationInfo(location)); </div><div class="line">   &#125; </div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProviderDisabled</span><span class="params">(String provider)</span> </span>&#123; </div><div class="line">     Log.d(TAG, provider + <span class="string">" disabled."</span>); </div><div class="line">   &#125; </div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onProviderEnabled</span><span class="params">(String provider)</span> </span>&#123; </div><div class="line">     Log.d(TAG, provider + <span class="string">" enabled."</span>); </div><div class="line">   &#125; </div><div class="line">	</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStatusChanged</span><span class="params">(String provider, <span class="keyword">int</span> status, </span></span></div><div class="line">Bundle extras)&#123; </div><div class="line">     Log.d(TAG, provider + <span class="string">" status changed."</span>); </div><div class="line">   &#125; </div><div class="line"> &#125;; </div><div class="line">	</div><div class="line"> <span class="meta">@Override</span> </div><div class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123; </div><div class="line">   <span class="keyword">super</span>.onCreate(savedInstanceState); </div><div class="line">   setContentView(R.layout.activity_main); </div><div class="line">   <span class="comment">// 获取 LocationManager </span></div><div class="line">   locationManager = (LocationManager)getSystemService(LOCATION_SERVICE); </div><div class="line"> &#125; </div><div class="line"> </div><div class="line"> <span class="meta">@Override</span> </div><div class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123; </div><div class="line">   <span class="keyword">super</span>.onResume(); </div><div class="line">   <span class="comment">// 指定一个 Provider </span></div><div class="line">   String currentProvider = LocationManager.NETWORK_PROVIDER; </div><div class="line">   Log.d(TAG, <span class="string">"CurrentProvider: "</span> + currentProvider); </div><div class="line">   <span class="comment">// 获取 Provider 最后一个记录的地址信息</span></div><div class="line">   Location lastKnownLocation = locationManager </div><div class="line">.getLastKnownLocation(currentProvider); </div><div class="line">   <span class="keyword">if</span> (lastKnownLocation != <span class="keyword">null</span>) &#123; </div><div class="line">     Log.d(TAG, <span class="string">"LastKnownLocation: "</span></div><div class="line">   + getLocationInfo(lastKnownLocation)); </div><div class="line">   &#125; <span class="keyword">else</span> &#123; </div><div class="line">     Log.d(TAG, <span class="string">"Last Location Unkown!"</span>); </div><div class="line">   &#125; </div><div class="line">   <span class="comment">// 注册监听器接受位置更新</span></div><div class="line">   locationManager.requestLocationUpdates(currentProvider, <span class="number">0</span>, <span class="number">0</span>, </div><div class="line">locationListener); </div><div class="line"> &#125; </div><div class="line"> </div><div class="line"> <span class="meta">@Override</span> </div><div class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123; </div><div class="line">   <span class="keyword">super</span>.onPause(); </div><div class="line">   <span class="comment">// 移除监听器</span></div><div class="line">   locationManager.removeUpdates(locationListener); </div><div class="line">   Log.d(TAG, <span class="string">"LocationListener: "</span> + locationListener + <span class="string">" removed."</span>); </div><div class="line"> &#125; </div><div class="line">	</div><div class="line"> <span class="comment">/** </span></div><div class="line">  * 将 Location 对象转换成字符串形式方便显示</div><div class="line">  * </div><div class="line">  * <span class="doctag">@param</span> location </div><div class="line">  *            Location 对象</div><div class="line">  * <span class="doctag">@return</span> 字符串形式的表示</div><div class="line">  */ </div><div class="line"> <span class="function"><span class="keyword">private</span> String <span class="title">getLocationInfo</span><span class="params">(Location location)</span> </span>&#123; </div><div class="line">   String info = <span class="string">""</span>; </div><div class="line">   info += <span class="string">"Longitude:"</span> + location.getLongitude(); </div><div class="line">   info += <span class="string">", Latitude:"</span> + location.getLatitude(); </div><div class="line">   <span class="keyword">if</span> (location.hasAltitude()) &#123; </div><div class="line">     info += <span class="string">", Altitude:"</span> + location.getAltitude(); </div><div class="line">   &#125; </div><div class="line">   <span class="keyword">if</span> (location.hasBearing()) &#123; </div><div class="line">     info += <span class="string">", Bearing:"</span> + location.getBearing(); </div><div class="line">   &#125; </div><div class="line">   <span class="keyword">return</span> info; </div><div class="line"> &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面代码看到，首先拿到LocationManager这个类的实例，然后选择相应的LocationProvider,指定LocationListener监听位置信息及LocationProvider的变化，从而就可以拿到位置信息了。</p>
<p>LocationManager(以下简称LM)相当于LocationManagerService(以下简称LMS)的代理,是整个定位系统的入口类，在Android中所有的系统服务都运行在一个专门的进程中(system_server)，system_server在系统启动的时候被启动，另外ServiceManager负责注册管理一系列的系统服务。而我们的APP运行在另外一个独立的进程中，因此想要访问系统服务的话，需要通过进程间通信的方式(IPC)。Android为此实现了BINDER，应用程序可以通过服务的代理的方式来调用服务(通过LM访问LMS)。</p>
<h3 id="LocationManager-LM-代理"><a href="#LocationManager-LM-代理" class="headerlink" title="LocationManager(LM)代理"></a>LocationManager(LM)代理</h3><hr>
<p>LM的构造函数如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LocationManager</span><span class="params">(Context context, ILocationManager service)</span> </span>&#123;</div><div class="line">    mService = service;</div><div class="line">    mContext = context;</div><div class="line">    mGpsMeasurementListenerTransport = <span class="keyword">new</span> GpsMeasurementListenerTransport(mContext, mService);</div><div class="line">    mGpsNavigationMessageListenerTransport =</div><div class="line">            <span class="keyword">new</span> GpsNavigationMessageListenerTransport(mContext, mService);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">private final ILocationManager mService;</div></pre></td></tr></table></figure>
<p>mService是LM的private变量,LM提供的关于location的核心方法都是通过mService调用到LMS中去的，比如上文例子中的：</p>
<ul>
<li>requestLocationUpdates<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLocationUpdates</span><span class="params">(String provider, <span class="keyword">long</span> minTime, <span class="keyword">float</span> minDistance, LocationListener listener)</span> </span>&#123;</div><div class="line">    checkProvider(provider);</div><div class="line">    checkListener(listener);</div><div class="line">    LocationRequest request = LocationRequest.createFromDeprecatedProvider(</div><div class="line">            provider, minTime, minDistance, <span class="keyword">false</span>);</div><div class="line">    requestLocationUpdates(request, listener, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">requestLocationUpdates</span><span class="params">(LocationRequest request, LocationListener listener,Looper looper, PendingIntent intent)</span> </span>&#123;</div><div class="line">    String packageName = mContext.getPackageName();</div><div class="line">    <span class="comment">// wrap the listener class</span></div><div class="line">    ListenerTransport transport = wrapListener(listener, looper);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        mService.requestLocationUpdates(request, transport, intent, packageName);</div><div class="line">   &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">       Log.e(TAG, <span class="string">"RemoteException"</span>, e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>因为mService 字段是在 LocationManager 的构造函数中被初始化的，因此找到 LocationManager构造函数被调用的地方就可以知道这个代理对象是哪里来的了。<br>在 ContextImpl.java(frameworks/base/core/java/android/app)中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">registerService(LOCATION_SERVICE, <span class="keyword">new</span> ServiceFetcher() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">        IBinder b = ServiceManager.getService(LOCATION_SERVICE);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LocationManager(ctx, ILocationManager.Stub.asInterface(b));</div><div class="line">    &#125;&#125;);</div></pre></td></tr></table></figure></p>
<p>从上面可以看到通过ServiceManager中拿到LOCATION_SERVICE的Binder引用，因为ServiceManager处于system_server进程中，我们的APP在另外一个进程中，在拿到Binder引用后，调用IXXXService.Stub.asInterface(IBinder obj)就可以得到IXXXService的实例，然后就可以通过IXXXService里的函数调用到XXXService里的函数。</p>
<p>ServiceManager.getService对应的LOCATION_SERVICE又是在哪里注册的呢?<br>在SystemServer.java(frameworks/base/services/java/com/android/server/)中,在系统启动时startOtherServices()通过ServiceManager.addService完成了LOCATION_SERVICE的注册:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    Slog.i(TAG, <span class="string">"Location Manager"</span>);</div><div class="line">    location = <span class="keyword">new</span> LocationManagerService(context);</div><div class="line">    ServiceManager.addService(Context.LOCATION_SERVICE, location);</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">    reportWtf(<span class="string">"starting Location Manager"</span>, e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>既然所有系统都是注册在 ServiceManager 中的，那么可不可以不使用代理，直接通过 ServiceManager 来获取系统服务对象，然后调用呢？答案是否定的。 在 Android 中，将公开的 API 和非公开的 API 做了划分。<strong>所有非公开的 API 在开发应用程序的 SDK 中是无法使用的，而 ServiceManager 就是属于非公开的 API。所以对于应用程序开发人员，根本无法接触到 ServiceManager 类</strong>。</p>
<h2 id="框架层"><a href="#框架层" class="headerlink" title="框架层"></a>框架层</h2><h3 id="LocationManagerService-LMS-分析"><a href="#LocationManagerService-LMS-分析" class="headerlink" title="LocationManagerService(LMS)分析"></a>LocationManagerService(LMS)分析</h3><hr>
<p>LMS构造函数，并没有做什么事情:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LocationManagerService</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>();</div><div class="line">    mContext = context;</div><div class="line">    <span class="comment">//AppOps全称是 Application Operations，是谷歌管理APP权限的一种机制</span></div><div class="line">    mAppOps = (AppOpsManager)context.getSystemService(Context.APP_OPS_SERVICE);</div><div class="line">    <span class="comment">//地理围栏Feauture初始化</span></div><div class="line">    mGeoFencerEnabled = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (D) Log.d(TAG, <span class="string">"Constructed"</span>);</div><div class="line">    <span class="comment">// most startup is deferred until systemReady()</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关键的操作放在了systemRunning函数里，systemRunning是SystemServer.java中startOtherService里调用的:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">   <span class="keyword">if</span> (locationF != <span class="keyword">null</span>) locationF.systemRunning();</div><div class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">    reportWtf(<span class="string">"Notifying Location Service running"</span>, e);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> LocationManagerService locationF = location;</div></pre></td></tr></table></figure>
<p>OK,我们看看systemRunning的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemRunning</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">        <span class="keyword">if</span> (D) Log.d(TAG, <span class="string">"systemReady()"</span>);</div><div class="line">        <span class="comment">// fetch package manager</span></div><div class="line">        mPackageManager = mContext.getPackageManager();</div><div class="line">        <span class="comment">// fetch power manager</span></div><div class="line">        mPowerManager = (PowerManager) mContext.getSystemService(Context.POWER_SERVICE);</div><div class="line">        </div><div class="line">        <span class="comment">//3.1.1内部类LocationWorkThread，消息处理器，主要处理位置变更，当有 Provider 发现有位置更新时，会首先发送消息到LMS，而在LMS中该消息最终就是在 LocationWorkerHandler 被处理的。这里的位置变更时LP主动调用reportLocation来通知LMS的。</span></div><div class="line">        mLocationHandler = <span class="keyword">new</span> LocationWorkerHandler(BackgroundThread.get().getLooper());</div><div class="line">        <span class="comment">//Android平台提供粗细两种精度的位置信息。其中，粗精度的位置信息由LocationFudger根据细精度的位置信息进行一定的数学模糊处理后得到。 </span></div><div class="line">        <span class="comment">// prepare mLocationHandler's dependents</span></div><div class="line">        mLocationFudger = <span class="keyword">new</span> LocationFudger(mContext, mLocationHandler);</div><div class="line">        <span class="comment">// 系统有一个黑白名单用于禁止使用某些特定的LP，在黑白名单中，LP由其对应的java包名指定</span></div><div class="line">        mBlacklist = <span class="keyword">new</span> LocationBlacklist(mContext, mLocationHandler);</div><div class="line">        mBlacklist.init();</div><div class="line">        <span class="comment">//GeofenceManager为地理围栏对象。</span></div><div class="line">        mGeofenceManager = <span class="keyword">new</span> GeofenceManager(mContext, mBlacklist);</div><div class="line"></div><div class="line">        <span class="comment">// Monitor for app ops mode changes.</span></div><div class="line">        AppOpsManager.OnOpChangedListener callback</div><div class="line">                = <span class="keyword">new</span> AppOpsManager.OnOpChangedInternalListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpChanged</span><span class="params">(<span class="keyword">int</span> op, String packageName)</span> </span>&#123;</div><div class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">                    <span class="keyword">for</span> (Receiver receiver : mReceivers.values()) &#123;</div><div class="line">                        receiver.updateMonitoring(<span class="keyword">true</span>);</div><div class="line">                    &#125;</div><div class="line">                    applyAllProviderRequirementsLocked();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        mAppOps.startWatchingMode(AppOpsManager.OP_COARSE_LOCATION, <span class="keyword">null</span>, callback);</div><div class="line"></div><div class="line">        mUserManager = (UserManager) mContext.getSystemService(Context.USER_SERVICE);</div><div class="line">        updateUserProfiles(mCurrentUserId);</div><div class="line">        <span class="comment">//3.1.2 关键函数 加载更新LP</span></div><div class="line">        <span class="comment">// prepare providers</span></div><div class="line">        loadProvidersLocked();</div><div class="line">        <span class="comment">//根据设置中的开关情况，开启或者禁止某个LP。在此函数中，各LP实现的LocationProviderInterface接口的enable/disable函数被调用</span></div><div class="line">        updateProvidersLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// listen for settings changes 监听设置数据库的变化，字段LOCATION_PROVIDERS_ALLOWED，当用户点击设置菜单按钮时，会改变数据库该字段的值 </span></div><div class="line">    mContext.getContentResolver().registerContentObserver(</div><div class="line">            Settings.Secure.getUriFor(Settings.Secure.LOCATION_PROVIDERS_ALLOWED), <span class="keyword">true</span>,</div><div class="line">            <span class="keyword">new</span> ContentObserver(mLocationHandler) &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange)</span> </span>&#123;</div><div class="line">                    <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">                        updateProvidersLocked();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;, UserHandle.USER_ALL);</div><div class="line">    mPackageMonitor.register(mContext, mLocationHandler.getLooper(), <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// listen for user change</span></div><div class="line">    <span class="comment">// 其他如监听用户切换，APK安装/卸载等事件在此不赘述  </span></div><div class="line">    IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</div><div class="line">    intentFilter.addAction(Intent.ACTION_USER_SWITCHED);</div><div class="line">    intentFilter.addAction(Intent.ACTION_MANAGED_PROFILE_ADDED);</div><div class="line">    intentFilter.addAction(Intent.ACTION_MANAGED_PROFILE_REMOVED);</div><div class="line"></div><div class="line">    mContext.registerReceiverAsUser(<span class="keyword">new</span> BroadcastReceiver() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">            String action = intent.getAction();</div><div class="line">            <span class="keyword">if</span> (Intent.ACTION_USER_SWITCHED.equals(action)) &#123;</div><div class="line">                switchUser(intent.getIntExtra(Intent.EXTRA_USER_HANDLE, <span class="number">0</span>));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_MANAGED_PROFILE_ADDED.equals(action)</div><div class="line">                    || Intent.ACTION_MANAGED_PROFILE_REMOVED.equals(action)) &#123;</div><div class="line">                updateUserProfiles(mCurrentUserId);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;, UserHandle.ALL, intentFilter, <span class="keyword">null</span>, mLocationHandler);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="loadProvidersLocked"><a href="#loadProvidersLocked" class="headerlink" title="loadProvidersLocked"></a>loadProvidersLocked</h4><hr>
<p>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadProvidersLocked</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// create a passive location provider, which is always enabled</span></div><div class="line">    <span class="comment">////创建PassiveProvider,这个LP始终是enable的。passive译为被动，它自己不能更新位置信息，而是靠其他LP来触发,位置更新，PassiveProvider的位置更新是由LMS接收到其他LP的位置更新通知后，主动调用PassiveProvider的updateLocation函数来完成的</span></div><div class="line">    PassiveProvider passiveProvider = <span class="keyword">new</span> PassiveProvider(<span class="keyword">this</span>);</div><div class="line">    <span class="comment">//LMS将保存所有的LP到一个ArrayList里</span></div><div class="line">    addProviderLocked(passiveProvider);</div><div class="line">    <span class="comment">//使能的LP放在一个Hashset里</span></div><div class="line">    mEnabledProviders.add(passiveProvider.getName());</div><div class="line">    mPassiveProvider = passiveProvider;</div><div class="line">    </div><div class="line">    <span class="comment">// 创建GPSLP实例</span></div><div class="line">    GpsLocationProvider gpsProvider = <span class="keyword">new</span> GpsLocationProvider(mContext, <span class="keyword">this</span>,</div><div class="line">            mLocationHandler.getLooper());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (GpsLocationProvider.isSupported()) &#123;</div><div class="line">        mGpsStatusProvider = gpsProvider.getGpsStatusProvider();</div><div class="line">        mNetInitiatedListener = gpsProvider.getNetInitiatedListener();</div><div class="line">        <span class="comment">//保存GPSLP </span></div><div class="line">        addProviderLocked(gpsProvider);</div><div class="line">        <span class="comment">//GPSLP是真实的位置提供者，将它保存在mRealProviders中</span></div><div class="line">        mRealProviders.put(LocationManager.GPS_PROVIDER, gpsProvider);</div><div class="line">    &#125;</div><div class="line">    mGpsMeasurementsProvider = gpsProvider.getGpsMeasurementsProvider();</div><div class="line">    mGpsNavigationMessageProvider = gpsProvider.getGpsNavigationMessageProvider();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">    Load package name(s) containing location provider support.</div><div class="line">    These packages can contain services implementing location providers:</div><div class="line">    Geocoder Provider, Network Location Provider, and</div><div class="line">    Fused Location Provider. They will each be searched for</div><div class="line">    service components implementing these providers.</div><div class="line">    The location framework also has support for installation</div><div class="line">    of new location providers at run-time. The new package does not</div><div class="line">    have to be explicitly listed here, however it must have a signature</div><div class="line">    that matches the signature of at least one package on this list.</div><div class="line">    */</div><div class="line">    <span class="comment">//config_locationProviderPackageNames存储了第三方LP的java包名。Android原生代码中该值为"com.android.location.fused",FusedLP对应的源码路径为frameworks/base/packages/FusedLocation</span></div><div class="line">    Resources resources = mContext.getResources();</div><div class="line">    ArrayList&lt;String&gt; providerPackageNames = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line">    String[] pkgs = resources.getStringArray(</div><div class="line">            com.android.internal.R.array.config_locationProviderPackageNames);</div><div class="line">    <span class="keyword">if</span> (D) Log.d(TAG, <span class="string">"certificates for location providers pulled from: "</span> +</div><div class="line">            Arrays.toString(pkgs));</div><div class="line">    <span class="keyword">if</span> (pkgs != <span class="keyword">null</span>) providerPackageNames.addAll(Arrays.asList(pkgs));</div><div class="line">   <span class="comment">//加载应用程序的实现的LP服务时，LMS将检查它们的签名信息以及版本信息</span></div><div class="line">    ensureFallbackFusedProviderPresentLocked(providerPackageNames);</div><div class="line"></div><div class="line">    <span class="comment">// 加载NetworkLP </span></div><div class="line">    LocationProviderProxy networkProvider = LocationProviderProxy.createAndBind(</div><div class="line">            mContext,</div><div class="line">            LocationManager.NETWORK_PROVIDER,</div><div class="line">            NETWORK_LOCATION_SERVICE_ACTION,</div><div class="line">            com.android.internal.R.bool.config_enableNetworkLocationOverlay,</div><div class="line">            com.android.internal.R.string.config_networkLocationProviderPackageName,</div><div class="line">            com.android.internal.R.array.config_locationProviderPackageNames,</div><div class="line">            mLocationHandler);</div><div class="line">    <span class="keyword">if</span> (networkProvider != <span class="keyword">null</span>) &#123;</div><div class="line">       <span class="comment">//NetworkLP属于真实的LP  </span></div><div class="line">        mRealProviders.put(LocationManager.NETWORK_PROVIDER, networkProvider);</div><div class="line">        <span class="comment">//应用程序实现的LP保存在mProxyProviders中  </span></div><div class="line">        mProxyProviders.add(networkProvider);</div><div class="line">        addProviderLocked(networkProvider);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Slog.w(TAG,  <span class="string">"no network location provider found"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 加载FusedLP  </span></div><div class="line">    LocationProviderProxy fusedLocationProvider = LocationProviderProxy.createAndBind(</div><div class="line">            mContext,</div><div class="line">            LocationManager.FUSED_PROVIDER,</div><div class="line">            FUSED_LOCATION_SERVICE_ACTION,</div><div class="line">            com.android.internal.R.bool.config_enableFusedLocationOverlay,</div><div class="line">            com.android.internal.R.string.config_fusedLocationProviderPackageName,</div><div class="line">            com.android.internal.R.array.config_locationProviderPackageNames,</div><div class="line">            mLocationHandler);</div><div class="line">    <span class="keyword">if</span> (fusedLocationProvider != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//FusedLP默认处于启用的状态</span></div><div class="line">        addProviderLocked(fusedLocationProvider);</div><div class="line">        mProxyProviders.add(fusedLocationProvider);</div><div class="line">        mEnabledProviders.add(fusedLocationProvider.getName());</div><div class="line">        mRealProviders.put(LocationManager.FUSED_PROVIDER, fusedLocationProvider);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Slog.e(TAG, <span class="string">"no fused location provider found"</span>,</div><div class="line">                <span class="keyword">new</span> IllegalStateException(<span class="string">"Location service needs a fused location provider"</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 加载Geocoder </span></div><div class="line">    mGeocodeProvider = GeocoderProxy.createAndBind(mContext,</div><div class="line">            com.android.internal.R.bool.config_enableGeocoderOverlay,</div><div class="line">            com.android.internal.R.string.config_geocoderProviderPackageName,</div><div class="line">            com.android.internal.R.array.config_locationProviderPackageNames,</div><div class="line">            mLocationHandler);</div><div class="line">    <span class="keyword">if</span> (mGeocodeProvider == <span class="keyword">null</span>) &#123;</div><div class="line">        Slog.e(TAG,  <span class="string">"no geocoder provider found"</span>);</div><div class="line">    &#125;</div><div class="line">   <span class="comment">//GeoFencerPackageName: com.qualcomm.location</span></div><div class="line">    mGeoFencerPackageName = resources.getString(</div><div class="line">            com.android.internal.R.string.config_geofenceServicesProvider);</div><div class="line">    <span class="keyword">if</span> (mGeoFencerPackageName != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            mPackageManager.resolveService(<span class="keyword">new</span> Intent(mGeoFencerPackageName), <span class="number">0</span>) != <span class="keyword">null</span>)&#123;</div><div class="line">        mGeoFencer = GeoFencerProxy.getGeoFencerProxy(mContext, mGeoFencerPackageName);</div><div class="line">        mGeoFencerEnabled = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mGeoFencer = <span class="keyword">null</span>;</div><div class="line">        mGeoFencerEnabled = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">   <span class="comment">//mComboNlpPackageName : com.qualcomm.location</span></div><div class="line">    mComboNlpPackageName = resources.getString(</div><div class="line">        com.android.internal.R.string.config_comboNetworkLocationProvider);</div><div class="line">    <span class="keyword">if</span> (mComboNlpPackageName != <span class="keyword">null</span>) &#123;</div><div class="line">        mComboNlpReadyMarker = mComboNlpPackageName + <span class="string">".nlp:ready"</span>;</div><div class="line">        mComboNlpScreenMarker = mComboNlpPackageName + <span class="string">".nlp:screen"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// bind to fused hardware provider if supported</span></div><div class="line">    <span class="comment">// in devices without support, requesting an instance of FlpHardwareProvider will raise an</span></div><div class="line">    <span class="comment">// exception, so make sure we only do that when supported</span></div><div class="line">    FlpHardwareProvider flpHardwareProvider;</div><div class="line">    <span class="keyword">if</span> (FlpHardwareProvider.isSupported()) &#123;</div><div class="line">        flpHardwareProvider = FlpHardwareProvider.getInstance(mContext);</div><div class="line">        FusedProxy fusedProxy = FusedProxy.createAndBind(</div><div class="line">                mContext,</div><div class="line">                mLocationHandler,</div><div class="line">                flpHardwareProvider.getLocationHardware(),</div><div class="line">                com.android.internal.R.bool.config_enableHardwareFlpOverlay,</div><div class="line">                com.android.internal.R.string.config_hardwareFlpPackageName,</div><div class="line">                com.android.internal.R.array.config_locationProviderPackageNames);</div><div class="line">        <span class="keyword">if</span> (fusedProxy == <span class="keyword">null</span>) &#123;</div><div class="line">            Slog.e(TAG, <span class="string">"Unable to bind FusedProxy."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        flpHardwareProvider = <span class="keyword">null</span>;</div><div class="line">        Slog.e(TAG, <span class="string">"FLP HAL not supported"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// bind to geofence provider</span></div><div class="line">    GeofenceProxy provider = GeofenceProxy.createAndBind(</div><div class="line">            mContext,com.android.internal.R.bool.config_enableGeofenceOverlay,</div><div class="line">            com.android.internal.R.string.config_geofenceProviderPackageName,</div><div class="line">            com.android.internal.R.array.config_locationProviderPackageNames,</div><div class="line">            mLocationHandler,</div><div class="line">            gpsProvider.getGpsGeofenceProxy(),</div><div class="line">            flpHardwareProvider != <span class="keyword">null</span> ? flpHardwareProvider.getGeofenceHardware() : <span class="keyword">null</span>);</div><div class="line">    <span class="keyword">if</span> (provider == <span class="keyword">null</span>) &#123;</div><div class="line">        Slog.e(TAG,  <span class="string">"Unable to bind FLP Geofence proxy."</span>);</div><div class="line">    &#125;</div><div class="line">    ... ...</div><div class="line">    ... ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在LMS的初始化函数中，loadProvidersLocked用于创建和加载系统中所有的LP如下：</p>
<ul>
<li>PassiveProvider：提供被动式的位置数据更新服务，其位置数据来源于其他LP</li>
<li>GpsLocationProvider：由LMS创建并加载，运行在LMS所在的进程system_process中，属于系统提供的LP服务</li>
<li>NetworkLocationProvider：该LP服务是由应用程序提供的</li>
<li>FusedLocationProvider：由FusedLocation.apk服务，属于系统提供的应用程序。其内部将使用其他的LP</li>
<li>GeocodeProvider：由第三方应用程序提供，一般和NetworkLP位于同一个应用程序中。</li>
</ul>
<h4 id="ProviderProxy描述"><a href="#ProviderProxy描述" class="headerlink" title="ProviderProxy描述"></a>ProviderProxy描述</h4><p>从上面加载NetworkLP/FusedLocationLP/GeocoderProvider等provider的代码中可以看到用到了ProviderProxy的模式:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// bind to network provider</span></div><div class="line">LocationProviderProxy networkProvider = LocationProviderProxy.createAndBind(</div><div class="line">    mContext,</div><div class="line">    LocationManager.NETWORK_PROVIDER,</div><div class="line">    NETWORK_LOCATION_SERVICE_ACTION,</div><div class="line">    com.android.internal.R.bool.config_enableNetworkLocationOverlay,</div><div class="line">    com.android.internal.R.string.config_networkLocationProviderPackageName,</div><div class="line">    com.android.internal.R.array.config_locationProviderPackageNames,</div><div class="line">mLocationHandler);</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// bind to geocoder provider</span></div><div class="line">mGeocodeProvider = GeocoderProxy.createAndBind(mContext,</div><div class="line">    com.android.internal.R.bool.config_enableGeocoderOverlay,</div><div class="line">    com.android.internal.R.string.config_geocoderProviderPackageName,</div><div class="line">    com.android.internal.R.array.config_locationProviderPackageNames,</div><div class="line">mLocationHandler);</div><div class="line">    <span class="keyword">if</span> (mGeocodeProvider == <span class="keyword">null</span>) &#123;</div><div class="line">        Slog.e(TAG,  <span class="string">"no geocoder provider found"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>如上所示，NetworkLP和GeocoderProvider分别用到了LocationProviderProxy(LPP)和GeocoderProviderProxy(GPP)的createAndBind的方法来找到相应的Provider，我们以LPP为例先来看下其构造函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">LocationProviderProxy</span><span class="params">(Context context, String name, String action,<span class="keyword">int</span> overlaySwitchResId, <span class="keyword">int</span> defaultServicePackageNameResId,</span></span></div><div class="line"><span class="keyword">int</span> initialPackageNamesResId, Handler handler) &#123;</div><div class="line">        mContext = context;</div><div class="line">        mName = name;</div><div class="line">        mServiceWatcher = <span class="keyword">new</span> ServiceWatcher(mContext, TAG + <span class="string">"-"</span> + name, action, overlaySwitchResId,defaultServicePackageNameResId, initialPackageNamesResId,mNewServiceWork, handler);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>其中ServiceWatcher是LocationProviderProxy中最重要的对象。在Android LMS架构中，应用程序实现的LP服务是通过Service提供的。ServiceWatcher是LocationProviderProxy中用来连接和监视应用程序实现的LP服务的。</p>
<p>再来看看createAndBind函数:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LocationProviderProxy <span class="title">createAndBind</span><span class="params">(Context context, String name, String action,<span class="keyword">int</span> overlaySwitchResId, <span class="keyword">int</span> defaultServicePackageNameResId,<span class="keyword">int</span> initialPackageNamesResId, Handler handler)</span> </span>&#123;</div><div class="line">        LocationProviderProxy proxy = <span class="keyword">new</span> LocationProviderProxy(context, name, action,overlaySwitchResId, defaultServicePackageNameResId, initialPackageNamesResId,handler);</div><div class="line">        <span class="keyword">if</span> (proxy.bind()) &#123;</div><div class="line">            <span class="keyword">return</span> proxy;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>继续跟踪bind函数:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">bind</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mServiceWatcher.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>bind函数直接调用了ServiceWatcher的start函数:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">        <span class="comment">//关键函数bindBestPackageLocked</span></div><div class="line">        <span class="keyword">if</span> (!bindBestPackageLocked(mServicePackageName)) <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 监听用户切换</span></div><div class="line">        IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</div><div class="line">        intentFilter.addAction(Intent.ACTION_USER_SWITCHED);</div><div class="line">        mContext.registerReceiverAsUser(<span class="keyword">new</span> BroadcastReceiver() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</div><div class="line">                String action = intent.getAction();</div><div class="line">                <span class="keyword">if</span> (Intent.ACTION_USER_SWITCHED.equals(action)) &#123;</div><div class="line">                    switchUser();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;, UserHandle.ALL, intentFilter, <span class="keyword">null</span>, mHandler);</div><div class="line"></div><div class="line">        <span class="comment">// 监听应用程序的安装，卸载，更新等广播事件</span></div><div class="line">        <span class="keyword">if</span> (mServicePackageName == <span class="keyword">null</span>) &#123;</div><div class="line">            mPackageMonitor.register(mContext, <span class="keyword">null</span>, UserHandle.ALL, <span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>其中的重要函数是bindBestPackageLocked,主要做了如下事情：</p>
<ul>
<li>检查目标应用程序的签名</li>
<li>根据createAndBind函数传入的第三个参数来找到目标应用程序实现的Service。以NetworkLP为例，目标应用程序必须提供一个名为”com.android.location.service.v2.NetworkLocationProvider”的服务。</li>
<li>绑定到该服务上，并获取一个类型为ILocationProvider的实例。通过该实例，LPP就可与目标应用程序中的LP服务交互，来调用LP的实现。</li>
</ul>
<p>bindBestPackageLocked中最重要的函数是bindToPackageLocked，其代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindToPackageLocked</span><span class="params">(String packageName, <span class="keyword">int</span> version, <span class="keyword">boolean</span> isMultiuser)</span> </span>&#123;</div><div class="line">        unbindLocked();</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(mAction);</div><div class="line">        intent.setPackage(packageName);</div><div class="line">        mPackageName = packageName;</div><div class="line">        mVersion = version;</div><div class="line">        mIsMultiuser = isMultiuser;</div><div class="line">        <span class="keyword">if</span> (D) Log.d(mTag, <span class="string">"binding "</span> + packageName + <span class="string">" (version "</span> + version + <span class="string">") ("</span></div><div class="line">                + (isMultiuser ? <span class="string">"multi"</span> : <span class="string">"single"</span>) + <span class="string">"-user)"</span>);</div><div class="line">        mContext.bindServiceAsUser(intent, <span class="keyword">this</span>, Context.BIND_AUTO_CREATE | Context.BIND_NOT_FOREGROUND</div><div class="line">                | Context.BIND_NOT_VISIBLE, mIsMultiuser ? UserHandle.OWNER : UserHandle.CURRENT);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>bindServiceAsUser函数绑定了第三方应用程序的LP服务，参数intent中传入的mAction是在ServiceWatcher的构造函数中赋值的，从LocationProviderProxy的代码中可以看出，这个action是在createAndBind函数中传入的，即在LMS中定义了此Action:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NETWORK_LOCATION_SERVICE_ACTION =</div><div class="line">            <span class="string">"com.android.location.service.v3.NetworkLocationProvider"</span></div></pre></td></tr></table></figure></p>
<p>绑定成功后，ServiceWatcher的onServiceConnected函数将被调用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder binder)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            String packageName = name.getPackageName();</div><div class="line">            <span class="keyword">if</span> (packageName.equals(mPackageName)) &#123;</div><div class="line">                <span class="keyword">if</span> (D) Log.d(mTag, packageName + <span class="string">" connected"</span>);</div><div class="line">                mBinder = binder;</div><div class="line">                <span class="keyword">if</span> (mHandler !=<span class="keyword">null</span> &amp;&amp; mNewServiceWork != <span class="keyword">null</span>) &#123;</div><div class="line">                    mHandler.post(mNewServiceWork);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Log.w(mTag, <span class="string">"unexpected onServiceConnected: "</span> + packageName);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>mNewServiceWork由LocationProviderProxy提供，是一个Runnable对象，其代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Runnable mNewServiceWork = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (D) Log.d(TAG, <span class="string">"applying state to connected service"</span>);</div><div class="line">        <span class="keyword">boolean</span> enabled;</div><div class="line">        ProviderProperties properties = <span class="keyword">null</span>;</div><div class="line">        ProviderRequest request;</div><div class="line">        WorkSource source;</div><div class="line">        ILocationProvider service;</div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            enabled = mEnabled;</div><div class="line">            request = mRequest;</div><div class="line">            source = mWorksource;</div><div class="line">            service = getService();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (service == <span class="keyword">null</span>) <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 获取LP的属性信息，这些属性统一封装在类型为ProviderProperties的对象中</span></div><div class="line">            properties = service.getProperties();</div><div class="line">            <span class="keyword">if</span> (properties == <span class="keyword">null</span>) &#123;</div><div class="line">                Log.e(TAG, mServiceWatcher.getBestPackageName() +</div><div class="line">                        <span class="string">" has invalid locatino provider properties"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// apply current state to new service</span></div><div class="line">            <span class="keyword">if</span> (enabled) &#123;</div><div class="line">                service.enable();<span class="comment">//启动这个LP</span></div><div class="line">                <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;<span class="comment">//如果客户端有请求，则将该请求发送给LP</span></div><div class="line">                    service.setRequest(request, source);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            Log.w(TAG, e);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="comment">// never let remote service crash system server</span></div><div class="line">            Log.e(TAG, <span class="string">"Exception from "</span> + mServiceWatcher.getBestPackageName(), e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            mProperties = properties;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h4 id="LocationProviderInterface描述"><a href="#LocationProviderInterface描述" class="headerlink" title="LocationProviderInterface描述"></a>LocationProviderInterface描述</h4><p>在 android.location 包中，用 LocationProvider(LP) 这个接口来描述。<br>而这一接口是提供给应用层 API使用的，在LMS中使用另一个接口来描述，这就是<br>com.android.location.provider.LocationProviderInterface(LPI)，LMS对于定位服务的实现均是通过调用LPI来完成的。</p>
<p><img src="http://static.zybuluo.com/EasonZxp/pm6ttuqw77eu3ohi6vcccu96/LocationProviderInterfaces.png" alt="LocationProviderInterfaces.png-35.3kB"></p>
<p>在 Android 源码中，实现LPI接口的类有四个：<br><img src="http://static.zybuluo.com/EasonZxp/cveczwhroarioo5ip4ryuxuj/LocationProviderInterfaces.png" alt="LocationProviderInterfaces.png-12.6kB"></p>
<h4 id="GpsLocationProvider实现"><a href="#GpsLocationProvider实现" class="headerlink" title="GpsLocationProvider实现"></a>GpsLocationProvider实现</h4><p>上文已经提到，LocationProviderInterface的实现类有四个。而实际上，在移动设备上我们可真正用于定位服务的实现通常只有两种：一种是通过Gps模块，一种是通过网络。GpsLocationProvider就是通过GPS模块来获取定位信息，是最重要的LP,现在我们就以GpsLocationProvider为例，看看LP的实现,照例先来看构造函数:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">GpsLocationProvider</span><span class="params">(Context context, ILocationManager ilocationManager,Looper looper)</span> </span>&#123;</div><div class="line">    mContext = context;</div><div class="line">    <span class="comment">//NTP即NetworkTimeProtocol，它是一种用来同步计算机时间的协议。</span></div><div class="line">    <span class="comment">//GpsLP创建一个NtpTrustedTime对象，该对象采用SNTP协议来和指定的NTP服务器通信以获取准确的时间。</span></div><div class="line">    mNtpTime = NtpTrustedTime.getInstance(context);</div><div class="line">    mILocationManager = ilocationManager;</div><div class="line">    mLocation.setExtras(mLocationExtras);</div><div class="line"></div><div class="line">    <span class="comment">// Create a wake lock</span></div><div class="line">    mPowerManager = (PowerManager) mContext.getSystemService(Context.POWER_SERVICE);</div><div class="line">    mWakeLock = mPowerManager.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, WAKELOCK_KEY);</div><div class="line">    mWakeLock.setReferenceCounted(<span class="keyword">true</span>);</div><div class="line">    mAlarmManager = (AlarmManager)mContext.getSystemService(Context.ALARM_SERVICE);</div><div class="line">    mWakeupIntent = PendingIntent.getBroadcast(mContext, <span class="number">0</span>, <span class="keyword">new</span> Intent(ALARM_WAKEUP), <span class="number">0</span>);</div><div class="line">    mTimeoutIntent = PendingIntent.getBroadcast(mContext, <span class="number">0</span>, <span class="keyword">new</span> Intent(ALARM_TIMEOUT), <span class="number">0</span>);</div><div class="line">    mConnMgr = (ConnectivityManager)context.getSystemService(Context.CONNECTIVITY_SERVICE);</div><div class="line">    <span class="comment">// App ops service to keep track of who is accessing the GPS</span></div><div class="line">    mAppOpsService = IAppOpsService.Stub.asInterface(ServiceManager.getService(</div><div class="line">            Context.APP_OPS_SERVICE));</div><div class="line">    <span class="comment">// Battery statistics service to be notified when GPS turns on or off</span></div><div class="line">    mBatteryStats = IBatteryStats.Stub.asInterface(ServiceManager.getService(</div><div class="line">            BatteryStats.SERVICE_NAME));</div><div class="line">    <span class="comment">//加载GPS配置文件(gps.conf)，加载了GPS相关参数包括SUPL服务器地址、端口号等</span></div><div class="line">    mProperties = <span class="keyword">new</span> Properties();</div><div class="line">    reloadGpsProperties(mContext, mProperties);</div><div class="line"></div><div class="line">    <span class="comment">// Create a GPS net-initiated handler.</span></div><div class="line">    <span class="comment">// 主要处理来自GPS HAL层通知的NI事件</span></div><div class="line">    mNIHandler = <span class="keyword">new</span> GpsNetInitiatedHandler(context,</div><div class="line">                                            mNetInitiatedListener,</div><div class="line">                                            mSuplEsEnabled);</div><div class="line"></div><div class="line">    <span class="comment">// construct handler, listen for events</span></div><div class="line">    <span class="comment">//注册ProviderHandler来处理消息</span></div><div class="line">    mHandler = <span class="keyword">new</span> ProviderHandler(looper);</div><div class="line">    <span class="comment">//监听广播，包括让SUPL的初始化/ALARM_WAKEUP/ALARM_TIMEOUT/亮灭屏/SIM卡状态变化</span></div><div class="line">    listenForBroadcasts();</div><div class="line"></div><div class="line">    <span class="comment">// also listen for PASSIVE_PROVIDER updates</span></div><div class="line">    <span class="comment">//开一个线程对PASSIVE_PROVIDER添加监听 </span></div><div class="line">    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            LocationManager locManager =</div><div class="line">                    (LocationManager) mContext.getSystemService(Context.LOCATION_SERVICE);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">long</span> minTime = <span class="number">0</span>;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">float</span> minDistance = <span class="number">0</span>;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> oneShot = <span class="keyword">false</span>;</div><div class="line">            LocationRequest request = LocationRequest.createFromDeprecatedProvider(</div><div class="line">                    LocationManager.PASSIVE_PROVIDER,</div><div class="line">                    minTime,</div><div class="line">                    minDistance,</div><div class="line">                    oneShot);</div><div class="line">            <span class="comment">// Don't keep track of this request since it's done on behalf of other clients</span></div><div class="line">            <span class="comment">// (which are kept track of separately).</span></div><div class="line">            request.setHideFromAppOps(<span class="keyword">true</span>);</div><div class="line">            <span class="comment">//接收来自NetworkLP的位置更新通知  </span></div><div class="line">            <span class="comment">//当GpsLP收到来自NetworkLP的位置信息后，将把他们传给GPS HAL层去处理</span></div><div class="line">            locManager.requestLocationUpdates(</div><div class="line">                    request,</div><div class="line">                    <span class="keyword">new</span> NetworkLocationListener(),</div><div class="line">                    mHandler.getLooper());</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    <span class="comment">// Add Observer for AGPS database change</span></div><div class="line">    addSettingDatabaseObserver(context);</div><div class="line"></div><div class="line">    <span class="comment">//实例GpsStatusListenerHelper，监听Gps状态变化并通过IGpsStatusListener在LM中的子类GpsStatusListenerTransport拿到GPS状态变化及NMEA信息</span></div><div class="line">    mListenerHelper = <span class="keyword">new</span> GpsStatusListenerHelper(mHandler) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAvailableInPlatform</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> GpsLocationProvider.isSupported();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isGpsEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> isEnabled();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">//实例化GpsMeasurementProvider</span></div><div class="line">    mGpsMeasurementsProvider = <span class="keyword">new</span> GpsMeasurementsProvider(mHandler) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailableInPlatform</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> GpsInterface_is_measurement_supported();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">registerWithService</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> native_start_measurement_collection();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">unregisterFromService</span><span class="params">()</span> </span>&#123;</div><div class="line">            native_stop_measurement_collection();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isGpsEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> isEnabled();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">//实例化GpsNavigationMessageProvider</span></div><div class="line">    mGpsNavigationMessageProvider = <span class="keyword">new</span> GpsNavigationMessageProvider(mHandler) &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAvailableInPlatform</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> native_is_navigation_message_supported();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">registerWithService</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> native_start_navigation_message_collection();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">unregisterFromService</span><span class="params">()</span> </span>&#123;</div><div class="line">            native_stop_navigation_message_collection();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isGpsEnabled</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> isEnabled();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面代码中看到在构造函数中注册了一个ProviderHandler(mHandler)，ProviderHandler是GpsLocationHandler的一个内部类，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="title">ProviderHandler</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">           <span class="keyword">super</span>(looper, <span class="keyword">null</span>, <span class="keyword">true</span> <span class="comment">/*async*/</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">           <span class="keyword">int</span> message = msg.what;</div><div class="line">           <span class="keyword">switch</span> (message) &#123;</div><div class="line">               <span class="keyword">case</span> ENABLE:</div><div class="line">                   <span class="keyword">if</span> (msg.arg1 == <span class="number">1</span>) &#123;</div><div class="line">                       handleEnable();</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       handleDisable();</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> SET_REQUEST:</div><div class="line">                   GpsRequest gpsRequest = (GpsRequest) msg.obj;</div><div class="line">                   handleSetRequest(gpsRequest.request, gpsRequest.source);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> UPDATE_NETWORK_STATE:</div><div class="line">                   handleUpdateNetworkState(msg.arg1, (NetworkInfo)msg.obj);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> INJECT_NTP_TIME:</div><div class="line">                   handleInjectNtpTime();</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> DOWNLOAD_XTRA_DATA:</div><div class="line">                   <span class="keyword">if</span> (mSupportsXtra) &#123;</div><div class="line">                       handleDownloadXtraData();</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> INJECT_NTP_TIME_FINISHED:</div><div class="line">                   mInjectNtpTimePending = STATE_IDLE;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> DOWNLOAD_XTRA_DATA_FINISHED:</div><div class="line">                   mDownloadXtraDataPending = STATE_IDLE;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               <span class="keyword">case</span> UPDATE_LOCATION:</div><div class="line">                   handleUpdateLocation((Location)msg.obj);</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (msg.arg2 == <span class="number">1</span>) &#123;</div><div class="line">               <span class="comment">// wakelock was taken for this message, release it</span></div><div class="line">               mWakeLock.release();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;;</div></pre></td></tr></table></figure></p>
<p>ProviderHandler 对于请求的处理逻辑并没有直接写在 handleMessage 方法中，而是对于每一个请求专门用一个方法来处理。GpsLP继承于LP，那么前文有描述过LocationProviderInterface的接口，在GpsLP中就是通过封装发送这些Message来提供的，如下：<br><img src="http://static.zybuluo.com/EasonZxp/87c93ypt4ho56vxkscjuj3nw/GpsLP_Interfaces.png" alt="GpsLP_Interfaces.png-19.2kB"></p>
<p>想对应的，在ProviderHandler处理这些消息时封装的接口如下：<br><img src="http://static.zybuluo.com/EasonZxp/rktpv9cndc3t1q1jg9wdfr4b/GpsLp_handleInterfaces.png" alt="GpsLP_handleInterfaces.png-30.4kB"></p>
<p>在GpsLP中包含了很多本地方法(native)，这些方法都是JNI层实现的：<br><img src="http://static.zybuluo.com/EasonZxp/ill34vgesjtvnblzi9s2444l/GpsLP_native_methods.png" alt="GpsLP_native_methods.png-29.2kB"></p>
<p>最后，GpsLP中还包含了被JNI层回调的方法,在JNI的实现中，通过这些方法的回调来传递 JNI 层的执行结果：<br><img src="http://static.zybuluo.com/EasonZxp/81h614p9zhw71roi7rawlsx4/GpsLP_jni_callback_methods.png" alt="GpsLP_jni_callback_methods.png-12.4kB"></p>
<p>具体这些方法的介绍与回调见下面分析。</p>
<h2 id="共享库层"><a href="#共享库层" class="headerlink" title="共享库层"></a>共享库层</h2><hr>
<p>共享库层包括了JNI和HAL。<br>JNI(Java Native Interface)层是JAVA调用C/C++的实现，依赖于HAL层为上层提供服务。<br>HAL(HardwareAbstractLayer)层是对硬件的抽象，这是整个模块实现的最底层。</p>
<h3 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h3><hr>
<p>JNI层的实现在com_android_server_location_GpsLocationProvider.cpp位于：(frameworks/base/services/jni)文件中。提供对于 GpsLocationProvider.java 中本地方法的实现。这些本地方法和JNI方法是一一对应的。<br>这种对应关系是在 register_android_server_location_GpsLocationProvider 方法中，通过 jniRegisterNativeMethods 函数建立的。 两个文件中函数的对应关系如下：<br><img src="http://static.zybuluo.com/EasonZxp/t9dgna2xtifg5h1i7m3t3r91/GpsLP_JNI.png" alt="GpsLP_JNI.png-30.6kB"></p>
<p>这其中，最为重要的是两个初始化方法:一个是 android_location_GpsLocationProvider_class_init_native 方法，这个方法的调用时在GPSLP中的静态代码块来调用：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &#123; class_init_native(); &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_location_GpsLocationProvider_class_init_native</span><span class="params">(JNIEnv* env, jclass clazz)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> err;</div><div class="line">    hw_module_t* <span class="keyword">module</span>;</div><div class="line">    <span class="comment">//初始化GPSLP中用到的回调方法</span></div><div class="line">    method_reportLocation = env-&gt;GetMethodID(clazz, <span class="string">"reportLocation"</span>, <span class="string">"(IDDDFFFJ)V"</span>);</div><div class="line">    method_reportStatus = env-&gt;GetMethodID(clazz, <span class="string">"reportStatus"</span>, <span class="string">"(I)V"</span>);</div><div class="line">    method_reportSvStatus = env-&gt;GetMethodID(clazz, <span class="string">"reportSvStatus"</span>, <span class="string">"()V"</span>);</div><div class="line">    method_reportAGpsStatus = env-&gt;GetMethodID(clazz, <span class="string">"reportAGpsStatus"</span>, <span class="string">"(II[B)V"</span>);</div><div class="line">    method_reportNmea = env-&gt;GetMethodID(clazz, <span class="string">"reportNmea"</span>, <span class="string">"(J)V"</span>);</div><div class="line">    method_setEngineCapabilities = env-&gt;GetMethodID(clazz, <span class="string">"setEngineCapabilities"</span>, <span class="string">"(I)V"</span>);</div><div class="line">    method_xtraDownloadRequest = env-&gt;GetMethodID(clazz, <span class="string">"xtraDownloadRequest"</span>, <span class="string">"()V"</span>);</div><div class="line">    method_reportNiNotification = env-&gt;GetMethodID(clazz, <span class="string">"reportNiNotification"</span>,</div><div class="line">            <span class="string">"(IIIIILjava/lang/String;Ljava/lang/String;IILjava/lang/String;)V"</span>);</div><div class="line">    method_requestRefLocation = env-&gt;GetMethodID(clazz,<span class="string">"requestRefLocation"</span>,<span class="string">"(I)V"</span>);</div><div class="line">    method_requestSetID = env-&gt;GetMethodID(clazz,<span class="string">"requestSetID"</span>,<span class="string">"(I)V"</span>);</div><div class="line">    method_requestUtcTime = env-&gt;GetMethodID(clazz,<span class="string">"requestUtcTime"</span>,<span class="string">"()V"</span>);</div><div class="line">    method_reportGeofenceTransition = env-&gt;GetMethodID(clazz,<span class="string">"reportGeofenceTransition"</span>,</div><div class="line">            <span class="string">"(IIDDDFFFJIJ)V"</span>);</div><div class="line">    method_reportGeofenceStatus = env-&gt;GetMethodID(clazz,<span class="string">"reportGeofenceStatus"</span>,</div><div class="line">            <span class="string">"(IIDDDFFFJ)V"</span>);</div><div class="line">    method_reportGeofenceAddStatus = env-&gt;GetMethodID(clazz,<span class="string">"reportGeofenceAddStatus"</span>,</div><div class="line">            <span class="string">"(II)V"</span>);</div><div class="line">    method_reportGeofenceRemoveStatus = env-&gt;GetMethodID(clazz,<span class="string">"reportGeofenceRemoveStatus"</span>,</div><div class="line">            <span class="string">"(II)V"</span>);</div><div class="line">    method_reportGeofenceResumeStatus = env-&gt;GetMethodID(clazz,<span class="string">"reportGeofenceResumeStatus"</span>,</div><div class="line">            <span class="string">"(II)V"</span>);</div><div class="line">    method_reportGeofencePauseStatus = env-&gt;GetMethodID(clazz,<span class="string">"reportGeofencePauseStatus"</span>,</div><div class="line">            <span class="string">"(II)V"</span>);</div><div class="line">    method_reportMeasurementData = env-&gt;GetMethodID(</div><div class="line">            clazz,</div><div class="line">            <span class="string">"reportMeasurementData"</span>,</div><div class="line">            <span class="string">"(Landroid/location/GpsMeasurementsEvent;)V"</span>);</div><div class="line">    method_reportNavigationMessages = env-&gt;GetMethodID(</div><div class="line">            clazz,</div><div class="line">            <span class="string">"reportNavigationMessage"</span>,</div><div class="line">            <span class="string">"(Landroid/location/GpsNavigationMessageEvent;)V"</span>);</div><div class="line">    <span class="comment">//找到GPS HAL层module库,并调用open方法，对应HAL层gps.c中的open_gps函数</span></div><div class="line">    err = hw_get_module(GPS_HARDWARE_MODULE_ID, (hw_module_t <span class="keyword">const</span>**)&amp;<span class="keyword">module</span>);</div><div class="line">    <span class="keyword">if</span> (err == <span class="number">0</span>) &#123;</div><div class="line">        hw_device_t* device;</div><div class="line">        err = <span class="keyword">module</span>-&gt;methods-&gt;open(<span class="keyword">module</span>, GPS_HARDWARE_MODULE_ID, &amp;device);</div><div class="line">        <span class="keyword">if</span> (err == <span class="number">0</span>) &#123;</div><div class="line">            gps_device_t* gps_device = (gps_device_t *)device;</div><div class="line">            <span class="comment">//拿到核心结构体指针GpsInterface</span></div><div class="line">            sGpsInterface = gps_device-&gt;get_gps_interface(gps_device);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//拿到GPS扩展实现的Interface指针，比如GpsXtraInterface，AGpsInterface，GpsNiInterface，GpsDebugInterface，AGpsRilInterface</span></div><div class="line">    <span class="keyword">if</span> (sGpsInterface) &#123;</div><div class="line">        sGpsXtraInterface =</div><div class="line">            (<span class="keyword">const</span> GpsXtraInterface*)sGpsInterface-&gt;get_extension(GPS_XTRA_INTERFACE);</div><div class="line">        sAGpsInterface =</div><div class="line">            (<span class="keyword">const</span> AGpsInterface*)sGpsInterface-&gt;get_extension(AGPS_INTERFACE);</div><div class="line">        sGpsNiInterface =</div><div class="line">            (<span class="keyword">const</span> GpsNiInterface*)sGpsInterface-&gt;get_extension(GPS_NI_INTERFACE);</div><div class="line">        sGpsDebugInterface =</div><div class="line">            (<span class="keyword">const</span> GpsDebugInterface*)sGpsInterface-&gt;get_extension(GPS_DEBUG_INTERFACE);</div><div class="line">        sAGpsRilInterface =</div><div class="line">            (<span class="keyword">const</span> AGpsRilInterface*)sGpsInterface-&gt;get_extension(AGPS_RIL_INTERFACE);</div><div class="line">        sGpsGeofencingInterface =</div><div class="line">            (<span class="keyword">const</span> GpsGeofencingInterface*)sGpsInterface-&gt;get_extension(GPS_GEOFENCING_INTERFACE);</div><div class="line">        sGpsMeasurementInterface =</div><div class="line">            (<span class="keyword">const</span> GpsMeasurementInterface*)sGpsInterface-&gt;get_extension(GPS_MEASUREMENT_INTERFACE);</div><div class="line">        sGpsNavigationMessageInterface =</div><div class="line">            (<span class="keyword">const</span> GpsNavigationMessageInterface*)sGpsInterface-&gt;get_extension(</div><div class="line">                    GPS_NAVIGATION_MESSAGE_INTERFACE);</div><div class="line">        sGnssConfigurationInterface =</div><div class="line">            (<span class="keyword">const</span> GnssConfigurationInterface*)sGpsInterface-&gt;get_extension(</div><div class="line">                    GNSS_CONFIGURATION_INTERFACE);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另一个是 android_location_GpsLocationProvider_init方法:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_location_GpsLocationProvider_init</span><span class="params">(JNIEnv* env, jobject obj)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// this must be set before calling into the HAL library</span></div><div class="line">    <span class="keyword">if</span> (!mCallbacksObj)</div><div class="line">        mCallbacksObj = env-&gt;NewGlobalRef(obj);</div><div class="line">    <span class="comment">//尝试调用maininterface的初始化函数来初始化GPS设备模块，如果初始化失败，直接返回false,在init中注册了用到的callback函数簇GpsCallbacks，包括位置信息的上报，状态信息的上报，NMEA信息的上报，设置能力集的callback等</span></div><div class="line">    <span class="keyword">if</span> (!sGpsInterface || sGpsInterface-&gt;init(&amp;sGpsCallbacks) != <span class="number">0</span>)</div><div class="line">        <span class="keyword">return</span> JNI_FALSE;</div><div class="line"></div><div class="line">    <span class="comment">// if XTRA initialization fails we will disable it by sGpsXtraInterface to NULL,but continue to allow the rest of the GPS interface to work.</span></div><div class="line">    <span class="comment">//尝试调用化GpsXtra/Agps/GpsNi/AGpsRilNi接口初始函数，并绑定各接口对应的callbacks，如果初始化失败，则使 sGpsXtraInterface 指向 NULL</span></div><div class="line">    <span class="keyword">if</span> (sGpsXtraInterface &amp;&amp; sGpsXtraInterface-&gt;init(&amp;sGpsXtraCallbacks) != <span class="number">0</span>)</div><div class="line">        sGpsXtraInterface = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (sAGpsInterface)</div><div class="line">        sAGpsInterface-&gt;init(&amp;sAGpsCallbacks);</div><div class="line">    <span class="keyword">if</span> (sGpsNiInterface)</div><div class="line">        sGpsNiInterface-&gt;init(&amp;sGpsNiCallbacks);</div><div class="line">    <span class="keyword">if</span> (sAGpsRilInterface)</div><div class="line">        sAGpsRilInterface-&gt;init(&amp;sAGpsRilCallbacks);</div><div class="line">    <span class="keyword">if</span> (sGpsGeofencingInterface)</div><div class="line">        sGpsGeofencingInterface-&gt;init(&amp;sGpsGeofenceCallbacks);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> JNI_TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过上面的两个函数JNI层就与HAL层打开了通路，JNI层拿到了HAL层实现的各种interface的指针，绑定了HAL层实现的各种核心callbacks。</p>
<h3 id="高通平台为例简要分析其HAL层实现"><a href="#高通平台为例简要分析其HAL层实现" class="headerlink" title="高通平台为例简要分析其HAL层实现"></a>高通平台为例简要分析其HAL层实现</h3><hr>
<p>Android GPS HAL层代码提供了一个标准框架，不同厂商都可以在该框架下实现基于自己芯片的HAL层code，与android framework交互。</p>
<p>gps.c中向上提供了一个GpsInterface，具体如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;                        </div><div class="line">    <span class="keyword">size_t</span>          size; <span class="comment">/** set to sizeof(GpsInterface) */</span>          </div><div class="line">    <span class="keyword">int</span>   (*init)( GpsCallbacks* callbacks );<span class="comment">//初始化</span></div><div class="line">    <span class="keyword">int</span>   (*start)( <span class="keyword">void</span> );<span class="comment">//开启gps导航                 </span></div><div class="line">    <span class="keyword">int</span>   (*stop)( <span class="keyword">void</span> );<span class="comment">//停止gps导航              </span></div><div class="line">    <span class="keyword">void</span>  (*cleanup)( <span class="keyword">void</span> );<span class="comment">/** Closes the interface. */</span></div><div class="line">    <span class="keyword">int</span>   (*inject_time)(GpsUtcTime time, <span class="keyword">int64_t</span> timeReference,</div><div class="line">                         <span class="keyword">int</span> uncertainty); <span class="comment">/** Injects the current time. */</span></div><div class="line">    <span class="comment">/** Injects current location from another location provider</span></div><div class="line">     *  (typically cell ID).</div><div class="line">     *  latitude and longitude are measured in degrees</div><div class="line">     *  expected accuracy is measured in meters</div><div class="line">     */</div><div class="line">    <span class="keyword">int</span>  (*inject_location)(<span class="keyword">double</span> latitude, <span class="keyword">double</span> longitude, <span class="keyword">float</span> accuracy);</div><div class="line">    <span class="keyword">void</span>  (*delete_aiding_data)(GpsAidingData flags);<span class="comment">//根据flag来判断是否使用上次星历数据 DELETE_ALL代表 冷启动</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * min_interval represents the time between fixes in milliseconds.</div><div class="line">     * preferred_accuracy represents the requested fix accuracy in meters.</div><div class="line">     * preferred_time represents the requested time to first fix in milliseconds.</div><div class="line">     */</div><div class="line">    <span class="keyword">int</span>   (*set_position_mode)(GpsPositionMode mode, GpsPositionRecurrence recurrence,</div><div class="line">            <span class="keyword">uint32_t</span> min_interval, <span class="keyword">uint32_t</span> preferred_accuracy, <span class="keyword">uint32_t</span> preferred_time);</div><div class="line">    <span class="comment">/** Get a pointer to extension information. */</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">void</span>* (*get_extension)(<span class="keyword">const</span> <span class="keyword">char</span>* name);</div><div class="line">&#125; GpsInterface;</div></pre></td></tr></table></figure></p>
<p>这个GpsInterface依靠下面的函数来获得，每个厂商需要实现get_gps_interface来注册自己的GpsInterface.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">const</span> GpsInterface* <span class="title">get_gps_interface</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<p>高通在loc.cpp这个文件中注册了自己的GpsInterface:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> GpsInterface sLocEngInterface =</div><div class="line">&#123;  </div><div class="line">   <span class="keyword">sizeof</span>(GpsInterface),</div><div class="line">   loc_init,</div><div class="line">   loc_start,</div><div class="line">   loc_stop,                            </div><div class="line">   loc_cleanup,                         </div><div class="line">   loc_inject_time,</div><div class="line">   loc_inject_location,                 </div><div class="line">   loc_delete_aiding_data,</div><div class="line">   loc_set_position_mode,               </div><div class="line">   loc_get_extension</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>接下来我们以其中两个重要的方法loc_init和loc_start为例看下高通是如何实现的：</p>
<ul>
<li><p>static int  loc_init(<strong>GpsCallbacks* callbacks</strong>);<br>在loc_init里注册了GpsCallbacks系列callback函数，然后在JNI的代码里会调用init，并且直接关联这些callback到GpsLocationProvider.java中对应的方法。这样的话就可以直接通过这些callback的调用实现JAVA methods的调用。比如在HAL层当GPS使能之后，将搜索到的卫星信息直接通过调用sv_status_cb(HAL)-&gt;sv_status_callback(JNI)-&gt;env-&gt;CallVoidMethod(mCallbacksObj, method_reportSvStatus)(JNI)-&gt;reportSvStatus(JAVA)这样JAVA侧就可以拿到卫星的x状态信息。<br>这些callbacks及相关信息在gps.h里定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Represents a location. */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="keyword">size_t</span>          size;<span class="comment">//size of GpsLocation</span></div><div class="line">    <span class="keyword">uint16_t</span>        flags;<span class="comment">//标志位</span></div><div class="line">    <span class="keyword">double</span>          latitude;<span class="comment">//维度</span></div><div class="line">    <span class="keyword">double</span>          longitude;<span class="comment">//经度</span></div><div class="line">    <span class="keyword">double</span>          altitude;<span class="comment">//高度</span></div><div class="line">    <span class="keyword">float</span>           speed;<span class="comment">//速度</span></div><div class="line">    <span class="keyword">float</span>           bearing;<span class="comment">//导向</span></div><div class="line">    <span class="keyword">float</span>           accuracy;<span class="comment">//精度</span></div><div class="line">    GpsUtcTime      timestamp;<span class="comment">//时间戳</span></div><div class="line">&#125; GpsLocation;</div><div class="line"></div><div class="line"><span class="comment">/** GPS status event values. */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">uint16_t</span> GpsStatusValue;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_STATUS_NONE             0 <span class="comment">/** GPS状态未知. */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_STATUS_SESSION_BEGIN    1 <span class="comment">/** GPS正在导航 */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_STATUS_SESSION_END      2 <span class="comment">/** GPS停止导航 */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_STATUS_ENGINE_ON        3 <span class="comment">/** GPS上电，但未导航*/</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_STATUS_ENGINE_OFF       4 <span class="comment">/** GPS已下电.*/</span></span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="keyword">size_t</span>          size;    <span class="comment">/** set to sizeof(GpsStatus) */</span></div><div class="line">    GpsStatusValue status;</div><div class="line">&#125; GpsStatus;</div><div class="line"></div><div class="line"><span class="comment">/** 卫星状态信息 */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="keyword">size_t</span>          size;    <span class="comment">/** set to sizeof(GpsSvStatus) */</span></div><div class="line">    <span class="keyword">int</span>         num_svs;     <span class="comment">/**可视卫星数 */</span></div><div class="line">    GpsSvInfo   sv_list[GPS_MAX_SVS]; <span class="comment">/**卫星信息list*/</span></div><div class="line">    <span class="comment">/*GPS接收机接收到广播星历（BroadcastEphemeris）与历书（Almanac）两种导航信息。广播星历包含基本轨道参数及摄动改正量，由其确定的卫星位置精度高，可用于定位计算。历书仅提供基本轨道参数，精度低，可用于接收机快速捕捉卫星和预报。*/</span></div><div class="line">    <span class="keyword">uint32_t</span>    ephemeris_mask;<span class="comment">//包含星历信息的卫星的bitmask</span></div><div class="line">    <span class="keyword">uint32_t</span>    almanac_mask;<span class="comment">//包含历书信息的卫星的bitmask</span></div><div class="line">    <span class="keyword">uint32_t</span>    used_in_fix_mask;<span class="comment">//参与定位的卫星的bitmask</span></div><div class="line">&#125; GpsSvStatus;</div><div class="line"></div><div class="line"><span class="comment">//GPS支持能力</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_SCHEDULING       0x0000001</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_MSB              0x0000002<span class="comment">//MS-Based AGPS</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_MSA              0x0000004<span class="comment">//MS-Assisted AGPS</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_SINGLE_SHOT      0x0000008<span class="comment">//Single-shot</span></span></div><div class="line"><span class="comment">/** GPS supports on demand time injection */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_ON_DEMAND_TIME   0x0000010</span></div><div class="line"><span class="comment">/** GPS supports Geofencing  */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_GEOFENCING       0x0000020</span></div><div class="line"><span class="comment">/** GPS supports Measurements */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_MEASUREMENTS     0x0000040</span></div><div class="line"><span class="comment">/** GPS supports Navigation Messages */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> GPS_CAPABILITY_NAV_MESSAGES     0x0000080</span></div><div class="line"></div><div class="line"><span class="comment">/** GPS callback structure. */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="keyword">size_t</span>      size;    <span class="comment">/** set to sizeof(GpsCallbacks) */</span></div><div class="line">    gps_location_callback location_cb;<span class="comment">//上报location信息 具体见上面结构体</span></div><div class="line">    gps_status_callback status_cb;<span class="comment">//上报状态信息 具体见上面5种状态</span></div><div class="line">    gps_sv_status_callback sv_status_cb;<span class="comment">//上报卫星状态信息 具体见上面结构体</span></div><div class="line">    gps_nmea_callback nmea_cb;<span class="comment">//上报nmea数据</span></div><div class="line">    gps_set_capabilities set_capabilities_cb;<span class="comment">//设定GPS能集力具体见上面类型</span></div><div class="line">    gps_acquire_wakelock acquire_wakelock_cb;<span class="comment">//</span></div><div class="line">    gps_release_wakelock release_wakelock_cb;<span class="comment">//</span></div><div class="line">    gps_create_thread create_thread_cb;<span class="comment">//创建JAVA线程</span></div><div class="line">    gps_request_utc_time request_utc_time_cb;<span class="comment">//申请UTC时间</span></div><div class="line">&#125; GpsCallbacks;</div></pre></td></tr></table></figure>
</li>
<li><p>loc_init 函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">loc_init</span><span class="params">(GpsCallbacks* callbacks)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> retVal = <span class="number">-1</span>;</div><div class="line">    ENTRY_LOG();</div><div class="line">    LOC_API_ADAPTER_EVENT_MASK_T event;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == callbacks) &#123;</div><div class="line">        LOC_LOGE(<span class="string">"loc_init failed. cb = NULL\n"</span>);</div><div class="line">        EXIT_LOG(%d, retVal);</div><div class="line">        <span class="keyword">return</span> retVal;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    event = LOC_API_ADAPTER_BIT_PARSED_POSITION_REPORT |</div><div class="line">            LOC_API_ADAPTER_BIT_SATELLITE_REPORT |</div><div class="line">            LOC_API_ADAPTER_BIT_LOCATION_SERVER_REQUEST |</div><div class="line">            LOC_API_ADAPTER_BIT_ASSISTANCE_DATA_REQUEST |</div><div class="line">            LOC_API_ADAPTER_BIT_IOCTL_REPORT |</div><div class="line">            LOC_API_ADAPTER_BIT_STATUS_REPORT |</div><div class="line">            LOC_API_ADAPTER_BIT_NMEA_1HZ_REPORT |</div><div class="line">            LOC_API_ADAPTER_BIT_NI_NOTIFY_VERIFY_REQUEST;</div><div class="line"></div><div class="line">    LocCallbacks clientCallbacks = &#123;local_loc_cb, <span class="comment">/* location_cb */</span></div><div class="line">                                callbacks-&gt;status_cb, <span class="comment">/* status_cb */</span></div><div class="line">                                local_sv_cb, <span class="comment">/* sv_status_cb */</span></div><div class="line">                                callbacks-&gt;nmea_cb, <span class="comment">/* nmea_cb */</span></div><div class="line">                                callbacks-&gt;set_capabilities_cb, <span class="comment">/* set_capabilities_cb */</span></div><div class="line">                                callbacks-&gt;acquire_wakelock_cb, <span class="comment">/* acquire_wakelock_cb */</span></div><div class="line">                                callbacks-&gt;release_wakelock_cb, <span class="comment">/* release_wakelock_cb */</span></div><div class="line">                                callbacks-&gt;create_thread_cb, <span class="comment">/* create_thread_cb */</span></div><div class="line">                                    <span class="literal">NULL</span>, <span class="comment">/* location_ext_parser */</span></div><div class="line">                                    <span class="literal">NULL</span>, <span class="comment">/* sv_ext_parser */</span></div><div class="line">                                callbacks-&gt;request_utc_time_cb, <span class="comment">/* request_utc_time_cb */</span></div><div class="line">                                loc_close_mdm_node  <span class="comment">/*loc_shutdown_cb*/</span>&#125;;</div><div class="line"></div><div class="line">    gps_loc_cb = callbacks-&gt;location_cb;</div><div class="line">    gps_sv_cb = callbacks-&gt;sv_status_cb;</div><div class="line"></div><div class="line">    retVal = loc_eng_init(loc_afw_data, &amp;clientCallbacks, event, <span class="literal">NULL</span>);</div><div class="line">    loc_afw_data.adapter-&gt;mSupportsAgpsRequests = !loc_afw_data.adapter-&gt;hasAgpsExtendedCapabilities();</div><div class="line">    loc_afw_data.adapter-&gt;mSupportsPositionInjection = !loc_afw_data.adapter-&gt;hasCPIExtendedCapabilities();</div><div class="line">    loc_afw_data.adapter-&gt;mSupportsTimeInjection = !loc_afw_data.adapter-&gt;hasCPIExtendedCapabilities();</div><div class="line">    loc_afw_data.adapter-&gt;setGpsLockMsg(<span class="number">0</span>);</div><div class="line">    loc_afw_data.adapter-&gt;requestUlp(getCarrierCapabilities());</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(retVal) &#123;</div><div class="line">        LOC_LOGE(<span class="string">"loc_eng_init() fail!"</span>);</div><div class="line">        <span class="keyword">goto</span> err;</div><div class="line">    &#125;</div><div class="line">    loc_afw_data.adapter-&gt;setPowerVoteRight(loc_get_target() == TARGET_QCA1530);</div><div class="line">    loc_afw_data.adapter-&gt;setPowerVote(<span class="literal">true</span>);</div><div class="line"></div><div class="line">    LOC_LOGD(<span class="string">"loc_eng_init() success!"</span>);</div><div class="line">err:</div><div class="line">    EXIT_LOG(%d, retVal);</div><div class="line">    <span class="keyword">return</span> retVal;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>loc_init函数主要做了：<br>(1) 高通自己封装了这些callbacks(clientCallbacks),并通过调用loc_eng_init(loc_afw_data, &amp;clientCallbacks, event, NULL);把这些callbacks与loc_afw_data核心全局变量关联起来，以方便使用。<br>(2) loc_afw_data.adapter-&gt;setPowerVote(true);通过LOC_API2上电</p>
<ul>
<li>loc_eng_init 函数<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">loc_eng_init</span><span class="params">(loc_eng_data_s_type &amp;loc_eng_data, LocCallbacks* callbacks,</span></span></div><div class="line">                 LOC_API_ADAPTER_EVENT_MASK_T event, ContextBase* context)</div><div class="line"></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> ret_val = <span class="number">0</span>;</div><div class="line">    ENTRY_LOG_CALLFLOW();</div><div class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == callbacks || <span class="number">0</span> == event) &#123;</div><div class="line">        LOC_LOGE(<span class="string">"loc_eng_init: bad parameters cb %p eMask %d"</span>, callbacks, event);</div><div class="line">        ret_val = <span class="number">-1</span>;</div><div class="line">        EXIT_LOG(%d, ret_val);</div><div class="line">        <span class="keyword">return</span> ret_val;</div><div class="line">    &#125;</div><div class="line">    STATE_CHECK((<span class="literal">NULL</span> == loc_eng_data.adapter),</div><div class="line">                <span class="string">"instance already initialized"</span>, <span class="keyword">return</span> <span class="number">0</span>);</div><div class="line">    <span class="built_in">memset</span>(&amp;loc_eng_data, <span class="number">0</span>, <span class="keyword">sizeof</span> (loc_eng_data));</div><div class="line">    <span class="comment">// Save callbacks</span></div><div class="line">    loc_eng_data.location_cb  = callbacks-&gt;location_cb;</div><div class="line">    loc_eng_data.sv_status_cb = callbacks-&gt;sv_status_cb;</div><div class="line">    loc_eng_data.status_cb    = callbacks-&gt;status_cb;</div><div class="line">    loc_eng_data.nmea_cb      = callbacks-&gt;nmea_cb;</div><div class="line">    loc_eng_data.set_capabilities_cb = callbacks-&gt;set_capabilities_cb;</div><div class="line">    loc_eng_data.acquire_wakelock_cb = callbacks-&gt;acquire_wakelock_cb;</div><div class="line">    loc_eng_data.release_wakelock_cb = callbacks-&gt;release_wakelock_cb;</div><div class="line">    loc_eng_data.request_utc_time_cb = callbacks-&gt;request_utc_time_cb;</div><div class="line">    loc_eng_data.location_ext_parser = callbacks-&gt;location_ext_parser ?</div><div class="line">        callbacks-&gt;location_ext_parser : noProc;</div><div class="line">    loc_eng_data.sv_ext_parser = callbacks-&gt;sv_ext_parser ?</div><div class="line">        callbacks-&gt;sv_ext_parser : noProc;</div><div class="line">    loc_eng_data.intermediateFix = gps_conf.INTERMEDIATE_POS;</div><div class="line">    loc_eng_data.shutdown_cb = callbacks-&gt;shutdown_cb;</div><div class="line">    <span class="comment">// initial states taken care of by the memset above</span></div><div class="line">    <span class="comment">// loc_eng_data.engine_status -- GPS_STATUS_NONE;</span></div><div class="line">    <span class="comment">// loc_eng_data.fix_session_status -- GPS_STATUS_NONE;</span></div><div class="line">    <span class="comment">// loc_eng_data.mute_session_state -- LOC_MUTE_SESS_NONE;</span></div><div class="line">    <span class="keyword">if</span> ((event &amp; LOC_API_ADAPTER_BIT_NMEA_1HZ_REPORT) &amp;&amp; (gps_conf.NMEA_PROVIDER == NMEA_PROVIDER_AP))</div><div class="line">    &#123;</div><div class="line">        event = event ^ LOC_API_ADAPTER_BIT_NMEA_1HZ_REPORT; <span class="comment">// unregister for modem NMEA report</span></div><div class="line">        loc_eng_data.generateNmea = <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        loc_eng_data.generateNmea = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    loc_eng_data.adapter =</div><div class="line">        <span class="keyword">new</span> LocEngAdapter(event, &amp;loc_eng_data, context,</div><div class="line">                       (MsgTask::tCreate)callbacks-&gt;create_thread_cb);</div><div class="line"></div><div class="line">    LOC_LOGD(<span class="string">"loc_eng_init created client, id = %p\n"</span>,</div><div class="line">             loc_eng_data.adapter);</div><div class="line">    loc_eng_data.adapter-&gt;sendMsg(<span class="keyword">new</span> LocEngInit(&amp;loc_eng_data));</div><div class="line">    EXIT_LOG(%d, ret_val);</div><div class="line">    <span class="keyword">return</span> ret_val;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>loc_eng_init 函数主要做了:<br>(1) 填充loc_init传下来的核心全局变量loc_afw_data(loc_eng_data)<br>(2) 构建LocEngAdapter，会通过MsgTask调用create_thread_cb来创建一个线程来管理msg收发，线程函数为loopMain<br>(3) sendMsg(new LocEngInit(&amp;loc_eng_data))该函数会把msg发送到message queue中，然后loopMain取出msg，依次执行msg的log()和Msg(), proc()用来处理该消息</p>
<p>继续看看LocEngInit这个msg是怎么处理的：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"> // case LOC_ENG_MSG_LOC_INIT:</div><div class="line">struct LocEngInit : public LocMsg &#123;</div><div class="line">    loc_eng_data_s_type* mLocEng;</div><div class="line">    inline LocEngInit(loc_eng_data_s_type* locEng) :</div><div class="line">        LocMsg(), mLocEng(locEng)</div><div class="line">    &#123;</div><div class="line">        locallog();</div><div class="line">    &#125;</div><div class="line">    inline virtual void proc() const &#123;</div><div class="line">        loc_eng_reinit(*mLocEng);</div><div class="line">        // set the capabilities</div><div class="line">        mLocEng-&gt;adapter-&gt;sendMsg(new LocEngSetCapabilities(mLocEng));</div><div class="line">    &#125;</div><div class="line">    inline void locallog() const</div><div class="line">    &#123;</div><div class="line">        LOC_LOGV("LocEngInit");</div><div class="line">    &#125;</div><div class="line">    inline virtual void log() const</div><div class="line">    &#123;</div><div class="line">        locallog();</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">在处理LocEngInit这个消息时又发送了LocEngSetCapabilities的Msg，继续：</div><div class="line">// case LOC_ENG_MSG_SET_CAPABILITIES:</div><div class="line">struct LocEngSetCapabilities : public LocMsg &#123;</div><div class="line">    loc_eng_data_s_type* mLocEng;</div><div class="line">    inline LocEngSetCapabilities(loc_eng_data_s_type* locEng) :</div><div class="line">        LocMsg(), mLocEng(locEng)</div><div class="line">    &#123;</div><div class="line">        locallog();</div><div class="line">    &#125;</div><div class="line">    inline virtual void proc() const &#123;</div><div class="line">        if (NULL != mLocEng-&gt;set_capabilities_cb) &#123;</div><div class="line">            LOC_LOGV("calling set_capabilities_cb 0x%x",</div><div class="line">                     gps_conf.CAPABILITIES);</div><div class="line">            mLocEng-&gt;set_capabilities_cb(gps_conf.CAPABILITIES);</div><div class="line">        &#125; else &#123;</div><div class="line">            LOC_LOGV("set_capabilities_cb is NULL.\n");</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    inline void locallog() const</div><div class="line">    &#123;</div><div class="line">        LOC_LOGV("LocEngSetCapabilities");</div><div class="line">    &#125;</div><div class="line">    inline virtual void log() const</div><div class="line">    &#123;</div><div class="line">        locallog();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>从上面看到最后会从/etc/gps.conf中读取能力集，并通过set_capabilities_cb回调到java的方法setEngineCapabilities(JNI中实现)：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//GPSLP中的setEngineCapabilities</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * called from native code to inform us what the GPS engine capabilities are</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setEngineCapabilities</span><span class="params">(<span class="keyword">int</span> capabilities)</span> </span>&#123;</div><div class="line">    mEngineCapabilities = capabilities;</div><div class="line">    <span class="keyword">if</span> (!hasCapability(GPS_CAPABILITY_ON_DEMAND_TIME) &amp;&amp; !mPeriodicTimeInjection) &#123;</div><div class="line">        mPeriodicTimeInjection = <span class="keyword">true</span>;</div><div class="line">        requestUtcTime();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>loc_start中直接调用loc_eng_start：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">static int loc_start()</div><div class="line">&#123;</div><div class="line">    ENTRY_LOG();</div><div class="line">    int ret_val = loc_eng_start(loc_afw_data);</div><div class="line">    EXIT_LOG(%d, ret_val);</div><div class="line">    return ret_val;</div><div class="line">&#125;</div><div class="line">//跟踪loc_eng_start</div><div class="line">int loc_eng_start(loc_eng_data_s_type &amp;loc_eng_data)</div><div class="line">&#123;</div><div class="line">   ENTRY_LOG_CALLFLOW();</div><div class="line">   INIT_CHECK(loc_eng_data.adapter, return -1);</div><div class="line"></div><div class="line">   if(! loc_eng_data.adapter-&gt;getUlpProxy()-&gt;sendStartFix())</div><div class="line">   &#123;</div><div class="line">       loc_eng_data.adapter-&gt;sendMsg(new LocEngStartFix(loc_eng_data.adapter));</div><div class="line">   &#125;</div><div class="line">   EXIT_LOG(%d, 0);</div><div class="line">   return 0;</div><div class="line">&#125;</div><div class="line">//同样sendMsg LocEngStartFix -&gt; LocEngStartFix msg.proc</div><div class="line">inline void LocEngStartFix::proc() const</div><div class="line">&#123;</div><div class="line">    loc_eng_data_s_type* locEng = (loc_eng_data_s_type*)mAdapter-&gt;getOwner();</div><div class="line">    loc_eng_start_handler(*locEng);</div><div class="line">&#125;</div><div class="line">//继续跟踪loc_eng_start_handler</div><div class="line">static int loc_eng_start_handler(loc_eng_data_s_type &amp;loc_eng_data)</div><div class="line">&#123;</div><div class="line">   ENTRY_LOG();</div><div class="line">   int ret_val = LOC_API_ADAPTER_ERR_SUCCESS;</div><div class="line">   //调用LocEngAdapter中的startFix函数来开启GPS</div><div class="line">   if (!loc_eng_data.adapter-&gt;isInSession()) &#123;</div><div class="line">       ret_val = loc_eng_data.adapter-&gt;startFix();</div><div class="line"></div><div class="line">       if (ret_val == LOC_API_ADAPTER_ERR_SUCCESS ||</div><div class="line">           ret_val == LOC_API_ADAPTER_ERR_ENGINE_DOWN ||</div><div class="line">           ret_val == LOC_API_ADAPTER_ERR_PHONE_OFFLINE ||</div><div class="line">           ret_val == LOC_API_ADAPTER_ERR_INTERNAL)</div><div class="line">       &#123;</div><div class="line">           loc_eng_data.adapter-&gt;setInSession(TRUE);</div><div class="line">           loc_inform_gps_status(loc_eng_data, GPS_STATUS_SESSION_BEGIN);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   EXIT_LOG(%d, ret_val);</div><div class="line">   return ret_val;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>LocEngAdapter中的startFix继续会调用到高通的LOC API层：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">enum</span> loc_api_adapter_err</span></div><div class="line">    <span class="title">startFix</span><span class="params">()</span></div><div class="line">&#123;   </div><div class="line">    <span class="keyword">return</span> mLocApi-&gt;startFix(mFixCriteria);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>LOC API代码路径：vendor/qcom/opensource/location/loc_api/*<br>LocApi2中的startFix会通过LOC QMI发消息到Modem侧去开启导航(SET_MODE msg + START_REQ msg)。</p>
<p>核心GPS业务的处理是在Modem核做的，而Android是跑在AP核上的，因此就必须要有核间的通讯来控制及传递GPS的业务逻辑及信息。QMI就是高通基于SMD来实现的一套多核间通讯的机制，基于C-S架构。Modem端GPS部分开启QMI Server，AP端GPS部分开启QMI client，通过LOC QMI的API来通讯。</p>
<h2 id="GPS使能流程图"><a href="#GPS使能流程图" class="headerlink" title="GPS使能流程图"></a>GPS使能流程图</h2><hr>
<p><img src="http://static.zybuluo.com/EasonZxp/pgrz91p83fyt7mkiec7iso0p/GPS%20%E5%90%AF%E5%8A%A8.png" alt="GPS_Boot"></p>
<h2 id="定位信息上报流程图"><a href="#定位信息上报流程图" class="headerlink" title="定位信息上报流程图"></a>定位信息上报流程图</h2><hr>
<p><img src="http://static.zybuluo.com/EasonZxp/xmnp8gvzv8wwn3bn6djn3e3i/Gps_Location_report.png" alt="Gps_Location_report.png-22.7kB"></p>
<h2 id="高通AGPS配置"><a href="#高通AGPS配置" class="headerlink" title="高通AGPS配置"></a>高通AGPS配置</h2><hr>
<ul>
<li>SUPl2.0不支持LTE</li>
<li>高通可选择性配置SUPL1.0和SUPL2.0(通过ModemNV或者gps.conf配置文件修改)</li>
<li>高通可选择性配置SUPL是否采用SSL加密传输</li>
<li>gps.conf中配置SUPL server和SUPL port</li>
<li>测试采用了cmcc server，配置如下:<br>SUPL_VER=0x10000<br>SUPL_HOST=221.176.0.55<br>SUPL_PORT=7275</li>
</ul>
<h3 id="QXDM-GPSlog抓取方法"><a href="#QXDM-GPSlog抓取方法" class="headerlink" title="QXDM GPSlog抓取方法"></a>QXDM GPSlog抓取方法</h3><hr>
<ul>
<li>load GNSS_ConfigurationFile.dmc</li>
<li>Ctrl-A全选，Ctrl-M过滤下面关键字<br><strong>pdsm_get_position|supl|pd_comm|tm_pdapi_pos_event_callback|tm_standalon</strong></li>
</ul>
<h3 id="QCAT-分析星历信息"><a href="#QCAT-分析星历信息" class="headerlink" title="QCAT 分析星历信息"></a>QCAT 分析星历信息</h3><hr>
<ul>
<li>用QXDM抓取所有的items到xxx.isf文件</li>
<li>用QCAT打开xxx.isf，选择过滤(0x1386/0x1387/0x147b)三条msg信息<br>0x1386/0x1387是与SUPL server交互的msg,0x147b是上报基本星历信息的msg</li>
<li>用ODLT删除星历，然后比对supl前后星历变化</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><hr>
<p><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-android-location/" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/opensource/os-cn-android-location/</a><br><a href="http://blog.csdn.net/dreamback1987/article/details/46712699" target="_blank" rel="external">http://blog.csdn.net/dreamback1987/article/details/46712699</a><br><a href="http://androiddoc.qiniudn.com/reference/android/location/package-summary.html" target="_blank" rel="external">http://androiddoc.qiniudn.com/reference/android/location/package-summary.html</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android-gps/" rel="tag"># android,gps</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/14/使用AndroidStudio NDK开发环境搭建/" rel="prev" title="使用AndroidStudio NDK开发环境搭建">
                使用AndroidStudio NDK开发环境搭建 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/03/02/基于高通平台Android-GPS架构分析/"
           data-title="基于高通平台Android-GPS架构分析" data-url="xiaoyubaby.github.io/2017/03/02/基于高通平台Android-GPS架构分析/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Eason Zhang" />
          <p class="site-author-name" itemprop="name">Eason Zhang</p>
           
              <p class="site-description motion-element" itemprop="description">Get busy living, or get busy dying...</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/XiaoYubaby" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Android-GPS-框架"><span class="nav-number">1.</span> <span class="nav-text">Android GPS 框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用层"><span class="nav-number">2.</span> <span class="nav-text">应用层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通过LM调用android-location"><span class="nav-number">2.1.</span> <span class="nav-text">通过LM调用android location</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LocationManager-LM-代理"><span class="nav-number">2.2.</span> <span class="nav-text">LocationManager(LM)代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#框架层"><span class="nav-number">3.</span> <span class="nav-text">框架层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#LocationManagerService-LMS-分析"><span class="nav-number">3.1.</span> <span class="nav-text">LocationManagerService(LMS)分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#loadProvidersLocked"><span class="nav-number">3.1.1.</span> <span class="nav-text">loadProvidersLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ProviderProxy描述"><span class="nav-number">3.1.2.</span> <span class="nav-text">ProviderProxy描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LocationProviderInterface描述"><span class="nav-number">3.1.3.</span> <span class="nav-text">LocationProviderInterface描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GpsLocationProvider实现"><span class="nav-number">3.1.4.</span> <span class="nav-text">GpsLocationProvider实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#共享库层"><span class="nav-number">4.</span> <span class="nav-text">共享库层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI"><span class="nav-number">4.1.</span> <span class="nav-text">JNI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高通平台为例简要分析其HAL层实现"><span class="nav-number">4.2.</span> <span class="nav-text">高通平台为例简要分析其HAL层实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GPS使能流程图"><span class="nav-number">5.</span> <span class="nav-text">GPS使能流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定位信息上报流程图"><span class="nav-number">6.</span> <span class="nav-text">定位信息上报流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高通AGPS配置"><span class="nav-number">7.</span> <span class="nav-text">高通AGPS配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QXDM-GPSlog抓取方法"><span class="nav-number">7.1.</span> <span class="nav-text">QXDM GPSlog抓取方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QCAT-分析星历信息"><span class="nav-number">7.2.</span> <span class="nav-text">QCAT 分析星历信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">8.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eason Zhang</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"XiaoYubaby"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
